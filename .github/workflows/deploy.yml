name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/zero-factory

            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git pull origin main

            echo "ğŸ” Detecting changed services..."
            CHANGED_FILES=$(git diff --name-only HEAD@{1} HEAD 2>/dev/null || echo "")

            # ë³€ê²½ëœ ì„œë¹„ìŠ¤ í™•ì¸
            BUILD_API=false
            BUILD_WEB=false
            BUILD_AI=false

            if echo "$CHANGED_FILES" | grep -q "^server/"; then
              BUILD_API=true
              echo "  â†’ API server changed"
            fi

            if echo "$CHANGED_FILES" | grep -q "^web/"; then
              BUILD_WEB=true
              echo "  â†’ Web frontend changed"
            fi

            if echo "$CHANGED_FILES" | grep -q "^ai-server/"; then
              BUILD_AI=true
              echo "  â†’ AI server changed (âš ï¸  build may take 10+ minutes)"
            fi

            # ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ë¹Œë“œ
            if [ "$BUILD_API" = true ]; then
              echo "ğŸ”¨ Building API server..."
              docker compose build api
            fi

            if [ "$BUILD_WEB" = true ]; then
              echo "ğŸ”¨ Building Web frontend..."
              docker compose build web
            fi

            if [ "$BUILD_AI" = true ]; then
              echo "ğŸ”¨ Building AI server (this may take a while)..."
              docker compose build ai-server
            fi

            # nginxë‚˜ docker-compose.yml ë³€ê²½ ì‹œ
            if echo "$CHANGED_FILES" | grep -q -E "^(nginx/|docker-compose\.yml)"; then
              echo "ğŸ”¨ Infrastructure changed, rebuilding all services..."
              docker compose build
            fi

            # ë³€ê²½ì‚¬í•­ì´ ì—†ìœ¼ë©´ ë¹Œë“œ ìŠ¤í‚µ
            if [ "$BUILD_API" = false ] && [ "$BUILD_WEB" = false ] && [ "$BUILD_AI" = false ]; then
              echo "â„¹ï¸  No service code changes detected, skipping build"
            fi

            echo "ğŸš€ Deploying all services..."
            docker compose up -d

            echo "â³ Waiting for services to stabilize..."
            if [ "$BUILD_AI" = true ]; then
              echo "  â†’ AI server was rebuilt, waiting 30 seconds for model loading..."
              sleep 30
            else
              sleep 15
            fi

            echo "ğŸ” Checking service health..."
            docker compose ps

            echo "âœ… Checking nginx configuration..."
            docker exec nginx nginx -t || echo "âš ï¸  Nginx configuration test failed"

            echo "âœ… Checking API health endpoint (internal)..."
            docker exec zero-factory-api-1 wget -q -O- http://localhost:3000/health || echo "âš ï¸  API health check failed"

            echo "âœ… Checking AI Server health endpoint (internal)..."
            docker exec ai-model-server wget -q -O- http://localhost:8000/health || echo "âš ï¸  AI Server health check failed"

            echo "âœ… Checking PostgreSQL database..."
            docker exec postgresdb pg_isready -U ${POSTGRES_USER:-postgres} || echo "âš ï¸  Database check failed"

            echo "âœ… Checking public HTTPS endpoints..."
            curl -k -f https://localhost/ || echo "âš ï¸  Main site HTTPS check failed"
            curl -k -f https://localhost/api/health || echo "âš ï¸  API via nginx check failed"

            echo "ğŸ§¹ Cleaning up unused Docker resources..."
            docker system prune -f

            echo "ğŸ‰ Deployment completed!"

      - name: Deployment Status
        if: success()
        run: echo "âœ… Deployment to EC2 completed successfully!"

      - name: Deployment Failed
        if: failure()
        run: echo "âŒ Deployment failed. Please check the logs."
