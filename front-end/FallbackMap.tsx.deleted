'use client'

import { useEffect, useRef, useState } from 'react'

interface FallbackMapProps {
  width?: string
  height?: string
  className?: string
}

export default function FallbackMap({ 
  width = '100%', 
  height = '452px', 
  className = ''
}: FallbackMapProps) {
  const canvasRef = useRef<HTMLCanvasElement>(null)
  const [markers] = useState([
    { x: 150, y: 120, title: 'ë‹¤íšŒìš©ì»µ ì¹´í˜', icon: 'â™»ï¸' },
    { x: 280, y: 100, title: 'ì¬í™œìš© ì„¼í„°', icon: 'â™»ï¸' },
    { x: 120, y: 200, title: 'í…€ë¸”ëŸ¬ í¬ì¸íŠ¸', icon: 'ğŸª' },
    { x: 320, y: 150, title: 'ì„¸ì²™ê¸°', icon: 'ğŸ§¼' },
    { x: 200, y: 180, title: 'ë°˜ë‚©í•¨', icon: 'ğŸ—‘ï¸' },
    { x: 100, y: 300, title: 'ì—ì½” ì¹´í˜', icon: 'â™»ï¸' },
    { x: 350, y: 280, title: 'ì¹œí™˜ê²½ ë§¤ì¥', icon: 'ğŸª' }
  ])

  useEffect(() => {
    const canvas = canvasRef.current
    if (!canvas) return

    const ctx = canvas.getContext('2d')
    if (!ctx) return

    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
    const rect = canvas.getBoundingClientRect()
    canvas.width = rect.width * window.devicePixelRatio
    canvas.height = rect.height * window.devicePixelRatio
    ctx.scale(window.devicePixelRatio, window.devicePixelRatio)

    // ë°°ê²½ ê·¸ë¦¬ê¸° (ì§€ë„ ìŠ¤íƒ€ì¼)
    const drawBackground = () => {
      // ë² ì´ìŠ¤ ë°°ê²½
      ctx.fillStyle = '#f0f8ff'
      ctx.fillRect(0, 0, rect.width, rect.height)
      
      // ë„ë¡œ íŒ¨í„´
      ctx.strokeStyle = '#e0e0e0'
      ctx.lineWidth = 2
      for (let i = 0; i < rect.width; i += 50) {
        ctx.beginPath()
        ctx.moveTo(i, 0)
        ctx.lineTo(i, rect.height)
        ctx.stroke()
      }
      for (let i = 0; i < rect.height; i += 50) {
        ctx.beginPath()
        ctx.moveTo(0, i)
        ctx.lineTo(rect.width, i)
        ctx.stroke()
      }

      // ì£¼ìš” ë„ë¡œ
      ctx.strokeStyle = '#d0d0d0'
      ctx.lineWidth = 4
      ctx.beginPath()
      ctx.moveTo(0, rect.height / 2)
      ctx.lineTo(rect.width, rect.height / 2)
      ctx.stroke()
      
      ctx.beginPath()
      ctx.moveTo(rect.width / 2, 0)
      ctx.lineTo(rect.width / 2, rect.height)
      ctx.stroke()

      // ê°€ìƒì˜ ê±´ë¬¼ë“¤
      ctx.fillStyle = '#f5f5f5'
      for (let i = 0; i < 10; i++) {
        const x = Math.random() * (rect.width - 40)
        const y = Math.random() * (rect.height - 40)
        const w = 20 + Math.random() * 20
        const h = 20 + Math.random() * 20
        ctx.fillRect(x, y, w, h)
        
        ctx.strokeStyle = '#ccc'
        ctx.lineWidth = 1
        ctx.strokeRect(x, y, w, h)
      }
    }

    // ë§ˆì»¤ ê·¸ë¦¬ê¸°
    const drawMarkers = () => {
      markers.forEach(marker => {
        // ë§ˆì»¤ ë°°ê²½ (ë‘¥ê·¼ ì‚¬ê°í˜• ìˆ˜ë™ ê·¸ë¦¬ê¸°)
        ctx.fillStyle = 'rgba(112,112,112,0.9)'
        const rectX = marker.x - 35
        const rectY = marker.y - 15
        const rectW = 70
        const rectH = 30
        const radius = 15
        
        ctx.beginPath()
        ctx.moveTo(rectX + radius, rectY)
        ctx.lineTo(rectX + rectW - radius, rectY)
        ctx.quadraticCurveTo(rectX + rectW, rectY, rectX + rectW, rectY + radius)
        ctx.lineTo(rectX + rectW, rectY + rectH - radius)
        ctx.quadraticCurveTo(rectX + rectW, rectY + rectH, rectX + rectW - radius, rectY + rectH)
        ctx.lineTo(rectX + radius, rectY + rectH)
        ctx.quadraticCurveTo(rectX, rectY + rectH, rectX, rectY + rectH - radius)
        ctx.lineTo(rectX, rectY + radius)
        ctx.quadraticCurveTo(rectX, rectY, rectX + radius, rectY)
        ctx.closePath()
        ctx.fill()
        
        // ë§ˆì»¤ í…Œë‘ë¦¬
        ctx.strokeStyle = 'rgba(255,255,255,0.3)'
        ctx.lineWidth = 1
        ctx.stroke()
        
        // ë§ˆì»¤ í…ìŠ¤íŠ¸
        ctx.fillStyle = 'white'
        ctx.font = 'bold 12px Arial'
        ctx.textAlign = 'center'
        ctx.fillText(`${marker.icon} ${marker.title}`, marker.x, marker.y + 3)
        
        // ë§ˆì»¤ í¬ì¸í„°
        ctx.fillStyle = 'rgba(112,112,112,0.9)'
        ctx.beginPath()
        ctx.moveTo(marker.x - 5, marker.y + 15)
        ctx.lineTo(marker.x + 5, marker.y + 15)
        ctx.lineTo(marker.x, marker.y + 25)
        ctx.closePath()
        ctx.fill()
      })
    }

    drawBackground()
    drawMarkers()

    // ìš°í•˜ë‹¨ì— "ì„ì‹œ ì§€ë„" ë¼ë²¨
    ctx.fillStyle = 'rgba(0,0,0,0.7)'
    ctx.font = '12px Arial'
    ctx.textAlign = 'right'
    ctx.fillText('ì„ì‹œ ì§€ë„ (ì¹´ì¹´ì˜¤ë§µ ë¡œë“œ ëŒ€ê¸°ì¤‘)', rect.width - 10, rect.height - 10)

  }, [markers])

  return (
    <div className={`relative ${className}`} style={{ width, height }}>
      <canvas 
        ref={canvasRef}
        style={{ width: '100%', height: '100%' }}
        className="rounded-md bg-blue-50"
      />
      
      {/* ì¹´ì¹´ì˜¤ë§µ ì¬ì‹œë„ ë²„íŠ¼ */}
      <div className="absolute top-2 right-2">
        <button 
          onClick={() => window.location.reload()}
          className="bg-white/90 hover:bg-white text-xs px-2 py-1 rounded shadow-sm border"
        >
          ğŸ”„ ì¹´ì¹´ì˜¤ë§µ ì¬ì‹œë„
        </button>
      </div>
    </div>
  )
}
