version: '3.8'

# 데이터 전처리 전용 Docker Compose 설정
# 사용법: docker-compose -f docker-compose.preprocess.yml up

services:
  preprocess:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai-preprocess

    # 환경 변수
    environment:
      - DEVICE=cuda  # GPU 사용
      - PYTHONUNBUFFERED=1

    # 볼륨 마운트
    volumes:
      # 원본 데이터
      - ./data:/app/data:ro  # 읽기 전용
      # 전처리된 데이터 출력
      - ./data_preprocessed:/app/data_preprocessed
      # 스크립트
      - ./scripts:/app/scripts
      - ./utils:/app/utils

    # Shared memory 크기 증가 (YOLO 멀티프로세싱용)
    shm_size: '2gb'

    # GPU 지원
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1  # GPU 1개만 사용
              capabilities: [gpu]

    # 전처리 스크립트 실행
    command: >
      python scripts/preprocess_container_images.py
      --input_dir /app/data
      --output_dir /app/data_preprocessed
      --model yolov8n.pt
      --confidence 0.25
      --padding 0.1
      --device cuda

    # 네트워크
    networks:
      - ai-network

networks:
  ai-network:
    driver: bridge
